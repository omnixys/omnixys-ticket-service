# @license GPL-3.0-or-later
# Copyright (C) 2025 Caleb Gyamfi - Omnixys Technologies
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the GNU General Public License for more details.
#
# For more information, visit <https://www.gnu.org/licenses/>.
#
# Omnixys Workflow Suite ‚Äì ci.yml
# Purpose: Continuous Integration pipeline for all pushes and pull requests.
# Language: Node / TypeScript (pnpm)

name: Continuous Integration ‚Äì Omnixys

on:
  push:
    branches:
      - main
      - '!release'
  pull_request:
    branches:
      - '**'
      - '!release'

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  OMNIXYS_ADMIN_USERNAME: ${{ secrets.OMNIXYS_ADMIN_USERNAME }}
  OMNIXYS_ADMIN_PASSWORD: ${{ secrets.OMNIXYS_ADMIN_PASSWORD }}
  OMNIXYS_USER_USERNAME: ${{ secrets.OMNIXYS_USER_USERNAME }}
  OMNIXYS_USER_PASSWORD: ${{ secrets.OMNIXYS_USER_PASSWORD }}
  OMNIXYS_EMAIL_DOMAIN: ${{ secrets.OMNIXYS_EMAIL_DOMAIN }}

  POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
  POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
  POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
  POSTGRES_SQL_HOST: postgres://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@localhost:5433/${{ secrets.POSTGRES_DB }}

  KAFKA_BROKER: ${{ secrets.KAFKA_BROKER }}
  TEMPO_URI: ${{ secrets.TEMPO_URI }}

  KC_DB_PASSWORD: ${{ secrets.KC_DB_PASSWORD }}
  KC_ADMIN_USERNAME: ${{ secrets.KC_ADMIN_USERNAME }}
  KC_ADMIN_PASSWORD: ${{ secrets.KC_ADMIN_PASSWORD }}
  KC_URL: ${{ secrets.KC_TEST_URL }}
  KC_REALM: ${{ secrets.KC_REALM }}
  KC_CLIENT_ID: ${{ secrets.KC_CLIENT_ID }}
  KC_CLIENT_SECRET: ${{ secrets.KC_CLIENT_SECRET }}

  KEYS_PATH: ${{ secrets.KEYS_PATH }}
  SERVICE: ${{ secrets.SERVICE }}
  PORT: ${{ secrets.PORT }}
  GRAPHQL_PLAYGROUND: ${{ secrets.GRAPHQL_PLAYGROUND }}
  NODE_ENV: ${{ secrets.NODE_ENV }}
  HTTPS: ${{ secrets.HTTPS }}

  LOG_LEVEL: ${{ secrets.LOG_LEVEL }}
  LOG_PRETTY: ${{ secrets.LOG_PRETTY }}
  LOG_DEFAULT: ${{ secrets.LOG_DEFAULT }}
  LOG_DIRECTORY: ${{ secrets.LOG_DIRECTORY }}
  LOG_FILE_DEFAULT_NAME: ${{ secrets.LOG_FILE_DEFAULT_NAME }}

  VALKEY_PASSWORD: ${{ secrets.VALKEY_PASSWORD }}

  POSTGRES_TEST_USER: ${{ secrets.POSTGRES_TEST_USER }}
  POSTGRES_TEST_PASSWORD: ${{ secrets.POSTGRES_TEST_PASSWORD }}
  POSTGRES_TEST_DB: ${{ secrets.POSTGRES_TEST_DB }}
  POSTGRES_TEST_URL: postgres://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@localhost:5433/${{ secrets.POSTGRES_DB }}

  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  SHADOW_DATABASE_URL: ${{ secrets.SHADOW_DATABASE_URL }}
jobs:
  ci:
    name: Run Lint, Build, Test, and Typecheck
    runs-on: ubuntu-latest
    if: >
      !contains(github.event.head_commit.message, 'chore(version)') &&
      !contains(github.event.head_commit.message, 'docs(changelog)')

    strategy:
      matrix:
        node-version: [24.10.0]

    services:
      postgres:
        image: postgres:18
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          TZ: Europe/Berlin
        options: >-
          --health-cmd="pg_isready -U postgres -d postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

      valkey:
        image: valkey/valkey:latest
        ports:
          - 6380:6379
        env:
          VALKEY_PASSWORD: ${{ env.VALKEY_PASSWORD }}
          options: >-
            --requirepass $VALKEY_PASSWORD
            --appendonly yes
            --health-cmd="valkey-cli -a $VALKEY_PASSWORD ping | grep PONG"
            --health-interval=5s
            --health-timeout=3s
            --health-retries=10

      zookeeper:
        image: wurstmeister/zookeeper
        ports:
          - 2181:2181
        env:
          ALLOW_ANONYMOUS_LOGIN: yes
        options: >-
          --health-cmd "echo ruok | nc localhost 2181 | grep imok"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 10

      kafka:
        image: wurstmeister/kafka
        env:
          KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
          KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
          KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
          KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
        ports:
          - 9092:9092
        options: >-
          --hostname kafka
          --health-cmd "bash -c 'nc -z localhost 9092 || exit 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 15
          --health-start-period 20s

    steps:
      - name: üßæ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Enable Corepack (pnpm)
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate

      - name: ‚öôÔ∏è Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'

      - name: ‚ôªÔ∏è Restore pnpm cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-${{ runner.os }}-

      - name: üì¶ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: üöÄ Start Keycloak (26.4)
        run: |
          docker run -d --name keycloak -p 8080:8080 \
           -e KC_BOOTSTRAP_ADMIN_USERNAME=${{ env.KC_ADMIN_USERNAME }} \
           -e KC_BOOTSTRAP_ADMIN_PASSWORD=${{ env.KC_ADMIN_PASSWORD }} \
           -v "$(pwd)/__tests__/keycloak/omnixys-realm.json:/opt/keycloak/data/import/omnixys-realm.json:ro" \
           --tmpfs /opt/keycloak/data:rw,size=200m \
           quay.io/keycloak/keycloak:26.4 \
           start-dev --import-realm --http-port=8080


          echo "‚è≥ Waiting for Keycloak..."
          for i in {1..10}; do
            if  curl -fs http://localhost:8080/realms/master >/dev/null 2>&1; then
              echo "‚úÖ Base realm 'master' available (after $i checks)"
              break
            fi
            echo "waiting for master realm ($i/10)..."
            sleep 5
          done

          echo "‚è≥ Waiting for imported realm 'omnixys'..."
          for i in {1..3}; do
            status=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Accept: application/json" \
              http://localhost:8080/realms/omnixys || echo 000)

            if [ "$status" = "200" ]; then
              echo "‚úÖ Realm 'omnixys' reachable (HTTP $status after $i tries)"
              docker ps
              exit 0
            fi

            echo "Realm not yet reachable (status $status, try $i/3)..."
            sleep 5
          done

          echo "‚ùå Keycloak did not become ready in time. Dumping logs..."
          docker logs keycloak
          exit 1

      - name: üîç Lint check
        run: pnpm lint

      - name: üß± Build project
        run: pnpm build

      # - name: üß™ Run tests
      #   run: pnpm t

      - name: üî§ Typecheck
        run: npx tsc

      - name: üìä Upload coverage to Codecov
        if: success()
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./__tests__/reports/e2e/coverage/lcov.info
          flags: unittests
          fail_ci_if_error: false
