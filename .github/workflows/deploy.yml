name: Deploy Omnixys Service

on:
  # push:
  #   branches: [main]
  workflow_run:
    workflows: ['Docker Build & Push ‚Äì Omnixys']
    types: [completed]

env:
  SERVICE: ${{ vars.SERVICE }}
  DOCKER_USER: ${{ secrets.DOCKER_USER }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: [self-hosted, omnixys-prod]
    concurrency:
      group: omnixys-prod
      cancel-in-progress: false

    steps:
      - name: üîë Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Deploy ${{ env.SERVICE }}
        run: |
          set -e
          cd /opt/omnixys/compose/app/backend

          echo "üöÄ Deploying service: $SERVICE"
          docker pull omnixys/"$SERVICE"-service
          docker image prune -f
          docker compose up -d --no-deps "$SERVICE"

          echo "‚è≥ Waiting for health..."
          for i in {1..30}; do
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' "omnixys-$SERVICE")
            if [ "$STATUS" = "healthy" ]; then
              echo "‚úÖ $SERVICE is healthy"
              exit 0
            fi
            sleep 2
          done

          echo "‚ùå $SERVICE did not become healthy"
          exit 1
