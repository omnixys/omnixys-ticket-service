name: Deploy Omnixys Service

on:
  push:
    branches: [main]

env:
  SERVICE: ${{ secrets.SERVICE }}
  DOCKER_USER: ${{ secrets.DOCKER_USER }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

jobs:
  deploy:
    runs-on: [self-hosted, omnixys-prod]
    concurrency:
      group: omnixys-prod
      cancel-in-progress: false
    
    steps:
      - name: ðŸ”‘ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Deploy ${{ env.SERVICE }}
        run: |
          set -e
          cd /opt/omnixys/compose/app/backend

          echo "ðŸš€ Deploying service: $SERVICE"
          docker pull omnixys/"$SERVICE"-service
          docker compose up -d "$SERVICE"
