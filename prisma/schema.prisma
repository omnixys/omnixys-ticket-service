/// ----------------------------------------------------------------------
/// Prisma Schema – Omnixys Ticket Service
/// Author: Caleb Gyamfi
/// License: GPL-3.0-or-later
/// ----------------------------------------------------------------------

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "linux-arm64-openssl-3.0.x", "linux-musl-arm64-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

/// ----------------------------------------------------------------------
/// Ticket: main aggregate root for the ticket domain
/// ----------------------------------------------------------------------
model Ticket {
  id                  String        @id @default(cuid())                  @map("id")

  eventId             String        @map("event_id")
  invitationId        String        @unique                                 @map("invitation_id")
  seatId              String?       @unique                                 @map("seat_id")
  guestProfileId      String?       @unique                                 @map("guest_profile_id")

  // Security: Device Binding
  deviceHash          String?       @map("device_hash")                    // Fingerprint
  devicePublicKey     String?       @map("device_public_key")              // POP (Proof-of-Possession)
  deviceActivationAt  DateTime?     @map("device_activation_at")
  deviceActivationIP  String?       @map("device_activation_ip")

  // Token Rotation
  lastNonce           Int?          @map("last_nonce")
  nextNonce           Int?          @map("next_nonce")
  rotationSeconds     Int           @default(30)                            @map("rotation_seconds")
  lastRotatedAt       DateTime?     @map("last_rotated_at")

  // State
  currentState        PresenceState @default(OUTSIDE)                       @map("current_state")
  revoked             Boolean       @default(false)                         @map("revoked")

  createdAt           DateTime      @default(now())                         @map("created_at")
  updatedAt           DateTime      @updatedAt                              @map("updated_at")

  // Relations
  scanLogs            ScanLog[]
  shareGuard          ShareGuard?

  @@index([eventId], name: "idx_ticket_event")
  @@index([guestProfileId], name: "idx_ticket_guest_profile")
  @@index([seatId], name: "idx_ticket_seat")
  @@index([currentState], name: "idx_ticket_state")

  @@map("ticket")
}

model ScanLog {
  id          String        @id @default(cuid())               @map("id")

  ticketId    String        @map("ticket_id")
  eventId     String        @map("event_id")
  byUserId    String?       @map("by_user_id")

  direction   PresenceState @map("direction")
  gate        String?       @map("gate")

  verdict     ScanVerdict   @default(UNKNOWN) @map("verdict")                  // OK / REPLAY / INVALID_NONCE / BLOCKED / DEVICE_MISMATCH
  nonce       Int?          @map("nonce")
  deviceHash  String?       @map("device_hash")

  createdAt   DateTime      @default(now())                    @map("created_at")

  // Relations
  ticket      Ticket        @relation(fields: [ticketId], references: [id])

  @@index([eventId, createdAt], name: "idx_scanlog_event_ts")
  @@index([ticketId], name: "idx_scanlog_ticket")
  @@index([verdict], name: "idx_scanlog_verdict")

  @@map("scan_log")
}

model ShareGuard {
  id           String     @id @default(cuid())                  @map("id")

  ticketId     String     @unique                               @map("ticket_id")

  failCount    Int        @default(0)                           @map("fail_count")
  lastFailAt   DateTime?  @map("last_fail_at")
  blockedUntil DateTime?  @map("blocked_until")
  reason       String?    @map("reason")

  ticket       Ticket     @relation(fields: [ticketId], references: [id])

  @@index([blockedUntil], name: "idx_shareguard_blocked")
  @@index([failCount],    name: "idx_shareguard_fails")

  @@map("share_guard")
}



/// ----------------------------------------------------------------------
/// Enums
/// ----------------------------------------------------------------------
enum PresenceState {
  INSIDE
  OUTSIDE
}

enum ScanVerdict {
  OK               // Ticket gültig
  REPLAY           // Nonce wiederholt → Replay-Attacke
  INVALID_NONCE    // Nonce nicht korrekt
  DEVICE_MISMATCH  // Ticket wurde auf anderem Gerät aktiviert
  BLOCKED          // ShareGuard blockiert Ticket
  REVOKED          // Ticket wurde manuell deaktiviert
  UNKNOWN          // Default fallback
}